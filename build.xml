<project name="hamcrest" default="all">

    <property name="version"
              value="SNAPSHOT"
              description="Version number to use in build files"/>

    <property name="haltonfailure"
              value="true"
              description="Whether to halt the build if the tests fail"/>

    <target name="all"
            depends="clean, package"
            description="Performs clean build, runs tests and packages for distribution"/>

    <target name="clean"
            description="Clean up all built files">
        <delete dir="build"/>
    </target>

    <target name="api"
            description="Build API">
        <java-to-jar srcdir="src/api"
                     destjar="build/hamcrest-api-${version}.jar"/>
    </target>

    <target name="generator"
            depends="api"
            description="Build code generator tool">
        <java-to-jar srcdir="src/generator"
                     destjar="build/hamcrest-generator-${version}.jar"
                     classpath="build/hamcrest-api-${version}.jar"/>
    </target>

    <target name="library"
            depends="api,generator"
            description="Build library of matchers">
        <java-to-jar srcdir="src/library"
                     destjar="build/hamcrest-library-${version}.jar"
                     classpath="build/hamcrest-api-${version}.jar"/>
        <!-- Generate one class with all static imports -->
        <mkdir dir="build/generated-code"/>
        <java classname="org.hamcrest.generator.config.XmlConfigurator"
              fork="yes"
              classpath="
                build/hamcrest-api-${version}.jar;
                build/hamcrest-generator-${version}.jar;
                build/hamcrest-library-${version}.jar
              ">
            <arg value="matchers.xml"/>
            <arg value="org.hamcrest.Matchers"/>
            <arg value="build/generated-code"/>
        </java>
        <!-- Append to library jar -->
        <java-to-jar srcdir="build/generated-code"
                     destjar="build/hamcrest-library-${version}.jar"
                     classpath="build/hamcrest-api-${version}.jar"/>
     </target>

    <target name="integration"
            depends="api, library"
            description="Build integration with external tools">
        <java-to-jar srcdir="src/integration"
                     destjar="build/hamcrest-integration-${version}.jar"
                     classpath="
                        build/hamcrest-api-${version}.jar;
                        build/hamcrest-library-${version}.jar"/>
    </target>

    <target name="unit-test"
            depends="api, library, integration, generator"
            description="Build and run unit tests.">
        <java-to-jar srcdir="src/unit-test"
                     destjar="build/hamcrest-unit-test-${version}.jar"
                     classpath="
                        build/hamcrest-api-${version}.jar;
                        build/hamcrest-library-${version}.jar;
                        build/hamcrest-integration-${version}.jar;
                        build/hamcrest-generator-${version}.jar"/>
        <junit printsummary="no" fork="no" haltonfailure="${haltonfailure}">
            <formatter type="brief" usefile="no"/>
            <classpath>
                <fileset dir="lib/integration">
                    <include name="*.jar"/>
                </fileset>
                <pathelement path="build/hamcrest-api-${version}.jar"/>
                <pathelement path="build/hamcrest-library-${version}.jar"/>
                <pathelement path="build/hamcrest-integration-${version}.jar"/>
                <pathelement path="build/hamcrest-generator-${version}.jar"/>
                <pathelement path="build/hamcrest-unit-test-${version}.jar"/>
            </classpath>
            <batchtest>
                <fileset dir="src/unit-test">
                    <exclude name="**/Abstract*"/>
                </fileset>
            </batchtest>
        </junit>
    </target>

    <target name="examples"
            depends="api, library, integration"
            description="Build and run unit tests.">
        <java-to-jar srcdir="src/examples"
                     destjar="build/hamcrest-examples-${version}.jar"
                     classpath="
                        build/hamcrest-api-${version}.jar;
                        build/hamcrest-library-${version}.jar;
                        build/hamcrest-integration-${version}.jar"/>
    </target>

    <target name="package"
            depends="api,generator,library,integration,unit-test,examples"
            description="Package for distribution">
        <zip zipfile="build/hamcrest-${version}.zip">
            <zipfileset dir="." prefix="hamcrest-${version}">
                <include name="src/**"/>
                <include name="lib/**"/>
                <include name="*.txt"/>
                <include name="build.xml"/>
            </zipfileset>
            <zipfileset dir="build" prefix="hamcrest-${version}">
                <include name="hamcrest-api-${version}.jar"/>
                <include name="hamcrest-library-${version}.jar"/>
                <include name="hamcrest-integration-${version}.jar"/>
            </zipfileset>
        </zip>
    </target>

    <macrodef name="java-to-jar"
              description="Compile Java source and build a Jar">
        <attribute name="srcdir" description="Directory containg Java source"/>
        <attribute name="destjar" description="Path to Jar"/>
        <attribute name="classpath" description="Anything additional to add on the classpath" default=""/>
        <sequential>
            <mkdir dir="build/temp/@{destjar}.contents"/>
            <javac srcdir="@{srcdir}" destdir="build/temp/@{destjar}.contents">
                <classpath>
                    <fileset dir="lib/integration">
                        <include name="*.jar"/>
                    </fileset>
                    <pathelement path="@{classpath}"/>
                </classpath>
            </javac>
            <copy file="LICENSE.txt" todir="build/temp/@{destjar}.contents"/>
            <!-- Put Java source in Jars for user's convenience. -->
            <copydir src="@{srcdir}" dest="build/temp/@{destjar}.contents"/>
            <jar jarfile="@{destjar}">
                <fileset dir="build/temp/@{destjar}.contents"/>
            </jar>
        </sequential>
    </macrodef>

</project>